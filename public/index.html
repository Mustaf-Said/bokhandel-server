<!DOCTYPE html>
<html lang="sv">

<head>
  <meta charset="UTF-8" />
  <title>Bokhandel Admin</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>Bokhandel Adminpanel</h1>

  <section>
    <h2>L√§gg till kund</h2>
    <form id="kundForm">
      <input type="text" placeholder="Namn" name="Namn" required><br>
      <input type="email" placeholder="Email" name="Email" required><br>
      <input type="text" placeholder="Mobilnummer" name="Mobile" required><br>
      <button type="submit">L√§gg till kund</button>
    </form>
  </section>

  <section>
    <h2>L√§gg till bok</h2>
    <form id="bokForm">
      <input type="text" placeholder="Titel" name="Titel" required><br>
      <input type="text" placeholder="F√∂rfattare" name="F√∂rfattare" required><br>
      <input type="number" placeholder="Pris" name="Pris" required><br>
      <input type="number" placeholder="LagerAntal" name="LagerAntal" required><br>
      <button type="submit">L√§gg till bok</button>
    </form>
  </section>

  <section>
    <h2>Skapa best√§llning</h2>
    <form id="orderForm">
      <select id="kundSelect" required></select><br>
      <div id="bokLista"></div>
      <button type="submit">Skapa best√§llning</button>
    </form>
  </section>

  <section>
    <h2>Alla best√§llningar</h2>
    <button onclick="visaBestallningar()">Uppdatera lista</button>
    <ul id="bestallningarLista"></ul>
  </section>

  <script>
    const api = 'http://localhost:3000';

    // üßç L√§gg till kund
    document.getElementById('kundForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const data = Object.fromEntries(form.entries());
      await fetch(api + '/kunder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      alert('Kund tillagd');
      e.target.reset();
      h√§mtaKunder();
    });

    // üìö L√§gg till bok
    document.getElementById('bokForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const data = Object.fromEntries(form.entries());
      data.Pris = parseFloat(data.Pris);
      data.LagerAntal = parseInt(data.LagerAntal);
      await fetch(api + '/bocker', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      alert('Bok tillagd');
      e.target.reset();
      h√§mtaBocker();
    });

    // üõí Skapa best√§llning
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const KundID = document.getElementById('kundSelect').value;
      const bokInputs = document.querySelectorAll('.bokRad input[type="number"]');
      const Bocker = Array.from(bokInputs)
        .filter(i => i.value > 0)
        .map(i => ({ BokID: i.dataset.bokid, Antal: parseInt(i.value) }));

      if (Bocker.length === 0) return alert('V√§lj minst en bok');

      const datum = new Date().toISOString().split('T')[0];

      await fetch(api + '/bestallningar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ KundID, Datum: datum, Bocker })
      });

      alert('Best√§llning skapad');
      e.target.reset();
      h√§mtaBocker(); // uppdatera lager
    });

    // üì• H√§mta kunder till dropdown
    async function h√§mtaKunder() {
      const res = await fetch(api + '/kunder');
      const kunder = await res.json();
      const select = document.getElementById('kundSelect');
      select.innerHTML = kunder.map(k => `<option value="${k.KundID}">${k.Namn}</option>`).join('');
    }

    // üì¶ H√§mta b√∂cker till checkboxlista
    async function h√§mtaBocker() {
      const res = await fetch(api + '/bocker');
      const bocker = await res.json();
      const lista = document.getElementById('bokLista');
      lista.innerHTML = bocker.map(b => `
        <div class="bokRad">
          <label>${b.Titel} (${b.LagerAntal} i lager): </label>
          <input type="number" min="0" max="${b.LagerAntal}" data-bokid="${b.BokID}" />
        </div>
      `).join('');
    }

    // üßæ Visa best√§llningar
    async function visaBestallningar() {
      const res = await fetch(api + '/bestallningar');
      const data = await res.json();
      const ul = document.getElementById('bestallningarLista');
      ul.innerHTML = data.map(b =>
        `<li><strong>${b.Namn}</strong> best√§llde "${b.Titel}" (${b.Antal} st) den ${b.Datum}</li>`
      ).join('');
    }

    // üîÉ Init
    h√§mtaKunder();
    h√§mtaBocker();
    visaBestallningar();
  </script>
</body>

</html>